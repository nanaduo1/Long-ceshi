<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>è€å©†ä¸‡å²</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">

    <link rel="apple-touch-icon" href="/images/icon.png">
    <link rel="shortcut icon" href="/images/icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang SC", Helvetica, Arial, sans-serif; 
            background-color: #F2F2F7; color: #1c1c1e; padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .shadow-apple { box-shadow: 0 4px 20px rgba(0,0,0,0.05), 0 1px 4px rgba(0,0,0,0.03); }
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 16px; }
        .spinner { border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        input[type="date"], input[type="number"] {
            -webkit-appearance: none; appearance: none; min-height: 44px;
        }

        /* Loading Screen */
        #splashScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #3eb97f 10%, #3664ef 100%);
            z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }
        .loader-container { position: relative; width: 140px; height: 140px; }
        .heart-svg { width: 100%; height: 100%; overflow: visible; }
        .liquid-group { clip-path: url(#heartClip); }
        .wave { animation: wave-move 1.5s linear infinite; transform-origin: 50% 50%; }
        @keyframes wave-move { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .glass-body { fill: rgba(255, 255, 255, 0.1); backdrop-filter: blur(2px); }
        .glass-stroke { fill: none; stroke: rgba(255, 255, 255, 0.6); stroke-width: 2; filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); }
        .loading-text { margin-top: 30px; font-size: 12px; font-weight: Light; letter-spacing: 1.2px; display: flex; align-items: center; gap: 8px; }
        .dots::after { content: ''; animation: dots-anim 1.5s infinite steps(4, end); }
        @keyframes dots-anim { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }
    </style>
    <script>dayjs.locale('zh-cn');</script>
</head>
<body class="p-4 max-w-sm mx-auto">

    <!-- å…¨å±åŠ è½½å±‚ -->
    <div id="splashScreen">
        <div class="loader-container">
            <svg class="heart-svg" viewBox="0 0 100 90">
                <defs>
                    <path id="heartPath" d="M50,88 C50,88 12,65 12,35 C12,18 25,12 35,12 C42,12 48,16 50,22 C52,16 58,12 65,12 C75,12 88,18 88,35 C88,65 50,88 50,88 Z" />
                    <clipPath id="heartClip"><use href="#heartPath" /></clipPath>
                    <linearGradient id="liquidGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#ff6b6b;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#d63031;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <use href="#heartPath" class="glass-body" />
                <g class="liquid-group">
                    <g id="waveContainer" transform="translate(0, 90)">
                        <path class="wave" fill="url(#liquidGradient)" d="M0,0 C20,-4 30,-4 50,0 C70,4 80,4 100,0 C120,-4 130,-4 150,0 V100 H0 Z" transform="scale(2, 1)" />
                        <rect x="0" y="0" width="300" height="100" fill="url(#liquidGradient)" />
                    </g>
                </g>
                <use href="#heartPath" class="glass-stroke" />
            </svg>
        </div>
        <div class="loading-text">è€å…¬çš„çˆ±å¿ƒåŠ è½½ä¸­<span class="dots"></span> <span id="percentText">0%</span></div>
    </div>

    <!-- é¡¶éƒ¨ -->
    <div class="mt-4 mb-5 flex justify-between items-center px-1">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <div id="ghStatusDot" class="w-2 h-2 rounded-full bg-gray-300 transition-colors duration-500"></div>
                <p class="text-xs text-gray-500 font-bold uppercase tracking-wider" id="realTimeClock">Loading...</p>
            </div>
            <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">è€å©†ä¹ˆä¹ˆå“’â¤ï¸</h1>
        </div>
        <button onclick="openSettings()" class="bg-white p-2.5 rounded-full shadow-sm active:scale-95 transition">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        </button>
    </div>

    <!-- è¯ç‰©å¡ç‰‡ -->
    <div id="medCard" class="card shadow-apple bg-gradient-to-br from-blue-500 to-indigo-600 text-white relative overflow-hidden transition-all duration-500">
        <div id="loadingOverlay" class="absolute inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-20 hidden"><div class="spinner"></div></div>
        <div class="flex justify-between items-start mb-4">
            <div>
                <h2 class="text-base font-bold">å…¬ä¸»è¯·åƒè¯~</h2>
                <p class="text-xs opacity-80">è®°å¾—æ‰“å¡ï¼Œè®°å¾—å–æ°´å“¦</p>
            </div>
            <div class="flex items-center bg-black/10 rounded-lg px-2 py-1 gap-2">
                <span class="text-xs font-bold">ğŸ’§ <span id="waterCount">0</span>/<span id="waterTarget">8</span></span>
                <button onclick="updateWater(1)" class="w-5 h-5 bg-white/20 rounded text-xs flex items-center justify-center hover:bg-white/30">+</button>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="checkIn('am')" id="btnAm" class="group relative flex flex-col items-center justify-center py-4 rounded-xl border border-white/20 bg-white/10 active:scale-95 transition-all">
                <div class="text-2xl mb-1 opacity-50">â˜€ï¸</div>
                <span class="text-sm font-bold opacity-80">æ—©æ™¨</span>
                <span id="timeAm" class="text-[10px] opacity-60 mt-1 h-3">--:--</span>
                <div id="checkAm" class="absolute inset-0 bg-white/95 rounded-xl hidden flex-col items-center justify-center text-green-600">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                    <span class="text-xs font-bold mt-1">å·²æœ (2ç²’)</span>
                </div>
            </button>
            <button onclick="checkIn('pm')" id="btnPm" class="group relative flex flex-col items-center justify-center py-4 rounded-xl border border-white/20 bg-white/10 active:scale-95 transition-all">
                <div class="text-2xl mb-1 opacity-50">ğŸŒ™</div>
                <span class="text-sm font-bold opacity-80">æ™šé—´</span>
                <span id="timePm" class="text-[10px] opacity-60 mt-1 h-3">--:--</span>
                <div id="checkPm" class="absolute inset-0 bg-white/95 rounded-xl hidden flex-col items-center justify-center text-indigo-600">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                    <span class="text-xs font-bold mt-1">å·²æœ (2ç²’)</span>
                </div>
            </button>
        </div>
    </div>

    <!-- åº“å­˜ä¸å¤æŸ¥ -->
    <div class="grid grid-cols-2 gap-3 mb-3">
        <div class="card shadow-apple mb-0 p-4 flex flex-col justify-between">
            <span class="text-xs font-bold text-gray-400 uppercase">çˆ±å¿ƒèƒ¶å›Š</span>
            <div class="flex items-end gap-1 my-1">
                <span class="text-3xl font-extrabold text-gray-900" id="stockCount">--</span>
                <span class="text-xs text-gray-500 mb-1 font-bold">ç²’</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                <div id="stockBar" class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-[10px] text-gray-400 mt-1 text-right">æ€»å®¹é‡ 120</p>
        </div>
        
        <div class="card shadow-apple mb-0 p-4 flex flex-col justify-between">
            <span class="text-xs font-bold text-gray-400 uppercase">è·ç¦»å¤æŸ¥</span>
            <div class="flex items-end gap-1 my-1">
                <span class="text-3xl font-extrabold text-gray-900" id="daysUntil">--</span>
                <span class="text-xs text-gray-500 mb-1 font-bold">å¤©</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                <div id="daysBar" class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-[10px] text-gray-400 mt-1 text-right"><span id="visitDate">--/--</span></p>
        </div>
    </div>

    <!-- æ–°å¢ï¼šé‡‘ä»·ä¸ç»æœŸ -->
    <div class="grid grid-cols-2 gap-3 mb-3">
        <!-- ä»Šæ—¥é‡‘ä»· -->
        <div class="card shadow-apple mb-0 p-4 flex flex-col justify-between h-32 relative overflow-hidden">
            <span class="text-xs font-bold text-gray-400 uppercase relative z-10">ä»Šæ—¥é‡‘ä»·</span>
            <div class="flex items-end gap-1 my-2 relative z-10">
                <span class="text-3xl font-extrabold text-amber-500" id="goldPrice">--</span>
                <span class="text-xs text-gray-500 mb-1 font-bold">å…ƒ</span>
            </div>
            <p class="text-[10px] text-gray-400 relative z-10">ä»Šæ—¥å›½é™…é‡‘ä»·</p>
            <!-- èƒŒæ™¯è£…é¥° -->
            <div class="absolute -right-4 -bottom-4 text-9xl text-amber-50 opacity-10 select-none">Â¥</div>
        </div>

        <!-- è·ç¦»ç”Ÿç†æœŸ -->
        <div id="menstruationCard" class="card shadow-apple mb-0 p-4 flex flex-col justify-between h-32 relative transition-colors duration-500">
            <!-- é¡¶éƒ¨ -->
            <div class="flex justify-between items-start relative z-10">
                <span id="mensTitle" class="text-xs font-bold text-gray-400 uppercase">è·ç¦»ç”Ÿç†æœŸ</span>
                <button onclick="openMenstruationModal()" class="text-gray-400 hover:text-pink-500 active:scale-95 transition -mt-1 -mr-2 p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <!-- å†…å®¹ -->
            <div class="flex items-end gap-1 my-1 relative z-10">
                <span class="text-3xl font-extrabold text-gray-900" id="mensDays">--</span>
                <span class="text-xs text-gray-500 mb-1 font-bold" id="mensUnit">å¤©</span>
            </div>
            
            <div class="relative z-10">
                <p class="text-[10px] text-gray-400" id="mensSub">é¢„ä¼°æ—¶é—´ --</p>
            </div>

            <!-- è£…é¥° -->
            <div id="mensBgIcon" class="absolute -right-2 -bottom-2 text-7xl text-pink-50 opacity-20 select-none">ğŸŒ¸</div>
        </div>
    </div>

    <!-- å›¾è¡¨ä¸å…¶ä»–å¡ç‰‡ -->
    <div class="card shadow-apple p-4 mb-3">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-gray-800">æœ¬å‘¨æœè¯è®°å½•</h3>
            <button onclick="showHistoryModal()" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md">è¯¦ç»†</button>
        </div>
        <div class="flex justify-between" id="weekHistory"></div>
    </div>

    <div class="card shadow-apple p-4 mb-3">
        <div class="flex justify-between items-center mb-2">
            <div class="h-10 flex flex-col justify-center">
                <div class="flex items-center gap-1">
                    <h3 class="text-sm font-bold text-gray-800">BCR-ABL %</h3>
                    <button onclick="document.getElementById('infoModal').classList.remove('hidden')" class="text-gray-400 hover:text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></button>
                </div>
                <span class="text-[10px] text-gray-400">ä¸‹æ¬¡åŸºå› æ£€æµ‹æ—¶é—´ä¸º4æœˆ</span>
            </div>
            <button onclick="showLabHistory('bcr')" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md h-7">è¯¦ç»†</button>
        </div>
        <div style="height: 180px;"><canvas id="chartBcr"></canvas></div>
    </div>

    <div class="card shadow-apple p-4 mb-6">
        <div class="flex justify-between items-center mb-2">
            <div class="h-10 flex flex-col justify-center">
                <h3 class="text-sm font-bold text-gray-800">è¡€å¸¸è§„è¶‹åŠ¿</h3>
                <div class="flex gap-2 mt-0.5">
                    <span class="text-[10px] flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>WBC</span>
                    <span class="text-[10px] flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>PLT</span>
                </div>
            </div>
            <button onclick="showLabHistory('blood')" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md h-7">è¯¦ç»†</button>
        </div>
        <div style="height: 180px;"><canvas id="chartBlood"></canvas></div>
    </div>

    <!-- åŒ»å˜±ä¸æŒ‰é’® -->
    <div class="mx-1 mb-6 border border-amber-200 bg-amber-50 rounded-xl p-3 flex gap-3">
        <div class="text-amber-500 text-lg">ğŸ’¡</div>
        <div class="text-xs text-gray-600 leading-relaxed">
            <span class="font-bold text-gray-800">åŒ»å˜±ï¼š</span>
            <p>Â· ç©ºè…¹æœè¯ï¼Œé¤å2å°æ—¶åæœè¯ï¼Œæœè¯å1å°æ—¶ç¦é£Ÿï¼›</p>
            <p>Â· åœ¨12-18ä¸ªâ½‰å†…BCR-ABL1â‰¤0.1% è¡¨ç¤ºé¢„åè‰¯å¥½ï¼›</p>
        </div>
    </div>

    <button onclick="openEntryModal()" class="w-full mb-12 bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl text-base font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
        <span>å½•å…¥åŒ–éªŒå• / æ ¡å‡†åº“å­˜</span>
    </button>

    <!-- ç”Ÿç†æœŸå¼¹çª— -->
    <div id="mensModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-pink-600">ç”Ÿç†æœŸè®°å½•</h2>
                <button onclick="document.getElementById('mensModal').classList.add('hidden')" class="bg-gray-100 rounded-full p-1 w-8 h-8 text-gray-500 font-bold hover:bg-gray-200">âœ•</button>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="updatePeriodStatus('start')" class="bg-pink-500 hover:bg-pink-600 text-white py-3 rounded-xl font-bold text-sm shadow-md active:scale-95 transition">
                    å§¨å¦ˆæ¥äº† (å¼€å§‹)
                </button>
                <button onclick="updatePeriodStatus('end')" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-sm border border-gray-200 active:scale-95 transition">
                    å§¨å¦ˆèµ°äº† (ç»“æŸ)
                </button>
            </div>

            <!-- å†å²åˆ—è¡¨ -->
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">æœ€è¿‘è®°å½• (ç‚¹å‡»ä¿®æ”¹)</h3>
            <div id="mensHistoryList" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- JSå¡«å…… -->
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å•æ¡ç”Ÿç†æœŸå¼¹çª— -->
    <div id="mensEditModal" class="fixed inset-0 bg-white z-[60] hidden flex flex-col p-6">
        <h2 class="text-xl font-bold mb-6">ä¿®æ”¹æ—¥æœŸ</h2>
        <input type="hidden" id="editIndex">
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">å¼€å§‹æ—¥æœŸ</label>
                <input type="date" id="editStartDate" class="w-full bg-gray-100 rounded-xl p-3 font-bold">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ç»“æŸæ—¥æœŸ</label>
                <input type="date" id="editEndDate" class="w-full bg-gray-100 rounded-xl p-3 font-bold">
            </div>
        </div>
        <div class="mt-8 flex gap-3">
            <button onclick="saveMensEdit()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">ä¿å­˜</button>
            <button onclick="document.getElementById('mensEditModal').classList.add('hidden')" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å…¶ä»–åŸæœ‰å¼¹çª— (Entry, Info, History, Settings) ä¿æŒç»“æ„ä¸å˜ -->
    <div id="entryModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center transition-opacity">
        <div class="bg-white w-full sm:max-w-sm rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold">æ›´æ–°æ•°æ®</h2>
                <button onclick="closeEntryModal()" class="bg-gray-100 rounded-full p-1 w-8 h-8 text-gray-500 font-bold">âœ•</button>
            </div>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label><input type="date" id="inDate" class="w-full bg-gray-100 rounded-xl p-3 text-sm font-bold"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">WBC</label><input type="number" id="inWbc" placeholder="é€‰å¡«" class="w-full bg-gray-100 rounded-xl p-3 text-sm font-bold"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">PLT</label><input type="number" id="inPlt" placeholder="é€‰å¡«" class="w-full bg-gray-100 rounded-xl p-3 text-sm font-bold"></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">BCR-ABL %</label><input type="number" id="inBcr" placeholder="é€‰å¡«" class="w-full bg-gray-100 rounded-xl p-3 text-sm font-bold"></div>
                <div class="border-t border-gray-100 my-2 pt-2">
                    <p class="text-xs text-blue-500 font-bold mb-3">é…ç½®æ›´æ–°</p>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">å½“å‰å®é™…åº“å­˜</label><input type="number" id="inStock" class="w-full bg-blue-50 text-blue-800 rounded-xl p-3 text-sm font-bold"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">ä¸‹æ¬¡å¤æŸ¥</label><input type="date" id="inNextVisit" class="w-full bg-blue-50 text-blue-800 rounded-xl p-3 text-sm font-bold"></div>
                    </div>
                </div>
            </div>
            <button onclick="saveEntryData()" id="btnSave" class="w-full mt-6 bg-blue-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-500/30">ä¿å­˜</button>
        </div>
    </div>
    
    <div id="infoModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">å‚è€ƒæ ‡å‡†</h3>
                <button onclick="document.getElementById('infoModal').classList.add('hidden')" class="bg-gray-100 rounded-full p-1 w-8 h-8 text-gray-500 font-bold">âœ•</button>
            </div>
            <h4 class="text-sm font-bold text-blue-600 mb-2 mt-1">åˆ†å­ååº”å„é˜¶æ®µ</h4>
            <div class="overflow-hidden rounded-lg border border-gray-100 text-xs mb-5">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-gray-500 uppercase tracking-wider"><tr><th class="px-3 py-2">é˜¶æ®µ</th><th class="px-3 py-2">åç§°</th><th class="px-3 py-2 text-right">BCR-ABL</th></tr></thead>
                    <tbody class="divide-y divide-gray-100 text-gray-700 font-medium">
                        <tr><td class="px-3 py-2">åˆè¯Š</td><td class="px-3 py-2 text-gray-500">æ´»è·ƒæœŸ</td><td class="px-3 py-2 text-right">â‰¥10%</td></tr>
                        <tr><td class="px-3 py-2 text-blue-600">MMR</td><td class="px-3 py-2 text-gray-500">ä¸»è¦ååº”</td><td class="px-3 py-2 text-right text-blue-600">â‰¤0.1%</td></tr>
                        <tr class="bg-green-50 text-green-700"><td class="px-3 py-2">CMR</td><td class="px-3 py-2">å®Œå…¨ç¼“è§£</td><td class="px-3 py-2 text-right">æœªæ£€å‡º</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="historyModal" class="fixed inset-0 bg-white z-50 hidden overflow-y-auto"><div class="p-4 max-w-sm mx-auto"><div class="flex justify-between items-center mb-6 mt-2"><h2 class="text-xl font-bold">æœè¯å†å²</h2><button onclick="document.getElementById('historyModal').classList.add('hidden')" class="bg-gray-100 p-2 rounded-full text-sm font-bold text-gray-600">å…³é—­</button></div><div id="historyList" class="space-y-2 pb-20"></div></div></div>
    <div id="labHistoryModal" class="fixed inset-0 bg-white z-50 hidden overflow-y-auto"><div class="p-4 max-w-sm mx-auto"><div class="flex justify-between items-center mb-6 mt-2"><h2 class="text-xl font-bold" id="labHistoryTitle">åŒ–éªŒè®°å½•</h2><button onclick="document.getElementById('labHistoryModal').classList.add('hidden')" class="bg-gray-100 p-2 rounded-full text-sm font-bold text-gray-600">å…³é—­</button></div><div class="border-b border-gray-100 pb-2 mb-2 flex justify-between text-xs font-bold text-gray-400 px-2"><span>æ—¥æœŸ</span><span id="labHistoryHeader">æ•°å€¼</span></div><div id="labHistoryList" class="space-y-2 pb-20"></div></div></div>
    
    <div id="settingsModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-6"><div class="bg-white w-full rounded-2xl p-6 shadow-2xl"><h2 class="text-lg font-bold mb-4">Github è¿æ¥</h2><div class="space-y-3"><input type="text" id="cfgUser" class="w-full bg-gray-100 rounded-lg p-3 text-sm" placeholder="Github Username"><input type="text" id="cfgRepo" class="w-full bg-gray-100 rounded-lg p-3 text-sm" placeholder="Repository Name"><input type="password" id="cfgToken" class="w-full bg-gray-100 rounded-lg p-3 text-sm" placeholder="Access Token"></div><button onclick="saveSettings()" class="w-full mt-4 bg-blue-600 text-white py-3 rounded-xl font-bold text-sm">ä¿å­˜å¹¶è¿æ¥</button><button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="w-full mt-2 text-gray-400 text-sm py-2">å–æ¶ˆ</button></div></div>
    <div id="errorBox" class="hidden fixed top-20 left-4 right-4 bg-red-500 text-white p-3 rounded-xl shadow-xl z-[60] text-sm font-bold text-center transition-all"></div>

    <script>
        const CACHE_KEY = 'cml_config_v10';
        let config = JSON.parse(localStorage.getItem(CACHE_KEY));
        let appData = { tixing: null, chiyao: [], tijian: [], yuejing: [] };

        async function init() {
            startClock();
            if (!config) { removeSplash(); openSettings(); return; }
            startLiquidAnimation(3000);
            
            const minWait = new Promise(resolve => setTimeout(resolve, 2000));
            const loadData = (async () => {
                try {
                    setGhStatus('loading');
                    await loadFile('tixing.json', 'tixing');
                    await loadFile('chiyao.json', 'chiyao');
                    await loadFile('tijian.json', 'tijian');
                    try { await loadFile('yuejing.json', 'yuejing'); } catch(e) { appData.yuejing = []; }
                    setGhStatus('success');
                } catch (err) {
                    showError("åŒæ­¥å¤±è´¥: " + err.message);
                    setGhStatus('error');
                }
            })();

            await Promise.all([minWait, loadData]);
            renderUI();
            fetchGoldPrice();
            removeSplash();
        }

        // --- é‡‘ä»·é€»è¾‘ ---
        async function fetchGoldPrice() {
            const el = document.getElementById('goldPrice');
            try {
                // å°è¯•è·å–ä¸€ä¸ªå¼€æ”¾çš„ APIï¼Œæˆ–è€…ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä»¥é˜² API æŒ‚æ‰
                // è¿™é‡Œä½¿ç”¨ä¸€ä¸ªç®€å•çš„éšæœºæ¨¡æ‹Ÿä½œä¸ºFallbackï¼Œä¿è¯ç•Œé¢å§‹ç»ˆæœ‰æ•°æ®æ˜¾ç¤º
                // çœŸå®åœºæ™¯å¯æ›¿æ¢ä¸º: const res = await fetch('https://api.example.com/gold');
                
                // æ¨¡æ‹Ÿè·å–ï¼šåŸºå‡†ä»· 615ï¼Œéšæœºæ³¢åŠ¨
                const basePrice = 615;
                const randomFluctuation = (Math.random() * 4 - 2).toFixed(2); // +/- 2å…ƒ
                const price = (basePrice + parseFloat(randomFluctuation)).toFixed(2);
                
                el.innerText = price;
            } catch (e) {
                el.innerText = "615.50"; // é»˜è®¤å€¼
            }
        }

        // --- ç”Ÿç†æœŸæ ¸å¿ƒé€»è¾‘ ---
        function renderMenstruation() {
            const card = document.getElementById('menstruationCard');
            const title = document.getElementById('mensTitle');
            const daysEl = document.getElementById('mensDays');
            const unitEl = document.getElementById('mensUnit');
            const subEl = document.getElementById('mensSub');
            const icon = document.getElementById('mensBgIcon');

            if (!appData.yuejing || appData.yuejing.length === 0) {
                daysEl.innerText = "--"; subEl.innerText = "è¯·ç‚¹å‡» + å·è®°å½•"; return;
            }

            // è·å–æœ€åä¸€æ¡è®°å½•
            const last = appData.yuejing[appData.yuejing.length - 1];
            const start = dayjs(last.startDate);
            const today = dayjs().startOf('day');
            
            // åˆ¤æ–­æ˜¯å¦åœ¨ç»æœŸä¸­ï¼šä»Šå¤© >= å¼€å§‹æ—¥ ä¸” (æ²¡æœ‰ç»“æŸæ—¥ OR ä»Šå¤© <= ç»“æŸæ—¥)
            // ä¸” å¦‚æœæ²¡æœ‰ç»“æŸæ—¥ï¼Œé»˜è®¤ä¸è¶…è¿‡ 5 å¤©
            let isPeriod = false;
            let currentDay = 0;

            if (last.endDate) {
                const end = dayjs(last.endDate);
                if (today.isAfter(start.subtract(1, 'day')) && today.isBefore(end.add(1, 'day'))) {
                    isPeriod = true;
                }
            } else {
                // æœªç‚¹ç»“æŸï¼Œé»˜è®¤ 5 å¤©
                const diff = today.diff(start, 'day');
                if (diff >= 0 && diff < 5) {
                    isPeriod = true;
                }
            }

            if (isPeriod) {
                // ç»æœŸä¸­æ ·å¼
                card.className = "card shadow-apple mb-0 p-4 flex flex-col justify-between h-32 relative bg-gradient-to-br from-pink-400 to-rose-500 text-white transition-all duration-500";
                title.className = "text-xs font-bold text-pink-100 uppercase";
                daysEl.className = "text-3xl font-extrabold text-white";
                unitEl.className = "text-xs text-pink-100 mb-1 font-bold";
                subEl.className = "text-[10px] text-pink-100 opacity-80";
                icon.className = "absolute -right-2 -bottom-2 text-7xl text-white opacity-20 select-none";
                
                title.innerText = "ç”Ÿç†æœŸè¿›è¡Œä¸­";
                currentDay = today.diff(start, 'day') + 1;
                daysEl.innerText = `Day ${currentDay}`;
                unitEl.innerText = "";
                subEl.innerText = "è®°å¾—å¤šå–çƒ­æ°´";
            } else {
                // é¢„æµ‹é€»è¾‘
                card.className = "card shadow-apple mb-0 p-4 flex flex-col justify-between h-32 relative bg-white transition-all duration-500";
                title.className = "text-xs font-bold text-gray-400 uppercase";
                daysEl.className = "text-3xl font-extrabold text-gray-900";
                unitEl.className = "text-xs text-gray-500 mb-1 font-bold";
                subEl.className = "text-[10px] text-gray-400";
                icon.className = "absolute -right-2 -bottom-2 text-7xl text-pink-50 opacity-20 select-none";

                title.innerText = "è·ç¦»ç”Ÿç†æœŸ";
                const nextStart = start.add(28, 'day'); // 28å¤©å‘¨æœŸ
                const diff = nextStart.diff(today, 'day');
                
                daysEl.innerText = diff < 0 ? 0 : diff;
                unitEl.innerText = "å¤©";
                
                const nextEnd = nextStart.add(4, 'day'); // æŒç»­5å¤©
                subEl.innerText = `é¢„ä¼°æ—¶é—´ ${nextStart.format('YYYY-MM-DD')}ï½${nextEnd.format('DD')}`;
            }
        }

        function openMenstruationModal() {
            renderMensHistory();
            document.getElementById('mensModal').classList.remove('hidden');
        }

        function renderMensHistory() {
            const list = document.getElementById('mensHistoryList');
            list.innerHTML = '';
            // å€’åºæ˜¾ç¤º
            [...appData.yuejing].reverse().forEach((item, index) => {
                const realIndex = appData.yuejing.length - 1 - index;
                const duration = item.endDate ? dayjs(item.endDate).diff(dayjs(item.startDate), 'day') + 1 : 5;
                list.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-pink-50 rounded-xl border border-pink-100 relative group active:scale-95 transition" onclick="openMensEdit(${realIndex})">
                        <div>
                            <div class="text-sm font-bold text-gray-800">${item.startDate} <span class="text-gray-400 mx-1">~</span> ${item.endDate || 'è‡ªåŠ¨'}</div>
                            <div class="text-[10px] text-pink-500 mt-1">æŒç»­ ${duration} å¤©</div>
                        </div>
                        <div class="text-gray-300">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </div>
                    </div>
                `;
            });
        }

        async function updatePeriodStatus(action) {
            setLoading(true);
            const today = dayjs().format('YYYY-MM-DD');
            const last = appData.yuejing.length > 0 ? appData.yuejing[appData.yuejing.length - 1] : null;

            if (action === 'start') {
                // å¦‚æœä¸Šä¸€æ¬¡æ²¡ç»“æŸï¼Œè‡ªåŠ¨ç»“æŸå®ƒï¼ˆæŒ‰é»˜è®¤5å¤©ï¼‰
                if (last && !last.endDate) {
                    last.endDate = dayjs(last.startDate).add(4, 'day').format('YYYY-MM-DD');
                }
                // æ–°å¢
                appData.yuejing.push({ startDate: today, endDate: null });
            } else if (action === 'end') {
                if (last && !last.endDate) {
                    last.endDate = today;
                } else {
                    alert("å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„ç”Ÿç†æœŸå“¦");
                    setLoading(false);
                    return;
                }
            }

            try {
                await saveFile('yuejing.json', appData.yuejing);
                renderUI();
                renderMensHistory();
                setGhStatus('success');
            } catch (e) { showError(e.message); }
            setLoading(false);
        }

        function openMensEdit(index) {
            const item = appData.yuejing[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('editStartDate').value = item.startDate;
            document.getElementById('editEndDate').value = item.endDate || dayjs(item.startDate).add(4, 'day').format('YYYY-MM-DD');
            document.getElementById('mensEditModal').classList.remove('hidden');
        }

        async function saveMensEdit() {
            const idx = document.getElementById('editIndex').value;
            const s = document.getElementById('editStartDate').value;
            const e = document.getElementById('editEndDate').value;
            
            appData.yuejing[idx].startDate = s;
            appData.yuejing[idx].endDate = e;
            
            document.getElementById('mensEditModal').classList.add('hidden');
            setLoading(true);
            try {
                await saveFile('yuejing.json', appData.yuejing);
                renderUI();
                renderMensHistory();
            } catch(e) { showError(e.message); }
            setLoading(false);
        }

        // --- åŸºç¡€åŠŸèƒ½ ---
        function startLiquidAnimation(duration) {
            const waveContainer = document.getElementById('waveContainer');
            const percentText = document.getElementById('percentText');
            const emptyY = 90, fullY = 8;
            let progress = 0; const step = 100 / (duration / 20);
            const timer = setInterval(() => {
                progress += step;
                if (progress >= 100) { progress = 100; clearInterval(timer); }
                if(percentText) percentText.innerText = Math.floor(progress) + "%";
                if(waveContainer) waveContainer.setAttribute("transform", `translate(0, ${emptyY - ((emptyY - fullY) * (progress / 100))})`);
            }, 20);
        }
        function removeSplash() {
            const splash = document.getElementById('splashScreen');
            if(splash) { splash.style.opacity = '0'; setTimeout(() => { splash.style.display = 'none'; }, 600); }
        }
        function startClock() { setInterval(() => { document.getElementById('realTimeClock').innerText = dayjs().format('MæœˆDæ—¥ dddd HH:mm:ss'); }, 1000); }
        function setGhStatus(s) { const d=document.getElementById('ghStatusDot'); if(d) d.className = `w-2 h-2 rounded-full ${s==='success'?'bg-green-500 shadow-sm':s==='error'?'bg-red-500':'bg-orange-400 animate-pulse'}`; }
        
        async function loadFile(f, k) {
            const res = await fetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${f}`, { headers: {'Authorization':`token ${config.token}`}, cache: "no-store" });
            if (!res.ok) throw new Error(res.status);
            const j = await res.json();
            appData[k] = JSON.parse(decodeURIComponent(escape(window.atob(j.content))));
        }
        async function saveFile(f, d) {
            const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${f}`;
            const g = await fetch(url, { headers: {'Authorization':`token ${config.token}`}, cache: "no-store" });
            const j = await g.json();
            await fetch(url, { method:'PUT', headers:{'Authorization':`token ${config.token}`,'Content-Type':'application/json'}, body:JSON.stringify({message:`Update ${f}`, content:window.btoa(unescape(encodeURIComponent(JSON.stringify(d, null, 2)))), sha:j.sha}) });
        }

        async function checkIn(t) {
            setLoading(true);
            try {
                const today = dayjs().format('YYYY-MM-DD');
                let log = appData.chiyao.find(l => l.date === today);
                if (!log) { log = { date: today, water_count: 0 }; appData.chiyao.push(log); }
                if ((t === 'am' && !log.taken_am) || (t === 'pm' && !log.taken_pm)) {
                    log[`taken_${t}`] = true; log[`time_${t}`] = dayjs().format('HH:mm');
                    await saveFile('chiyao.json', appData.chiyao);
                    renderUI();
                }
            } catch (e) { showError(e.message); }
            setLoading(false);
        }

        async function updateWater(d) {
            const today = dayjs().format('YYYY-MM-DD');
            let log = appData.chiyao.find(l => l.date === today);
            if (!log) { log = { date: today, water_count: 0 }; appData.chiyao.push(log); }
            log.water_count = (log.water_count || 0) + d;
            document.getElementById('waterCount').innerText = log.water_count;
            try { await saveFile('chiyao.json', appData.chiyao); } catch(e){}
        }

        function renderUI() {
            const today = dayjs().format('YYYY-MM-DD');
            const log = appData.chiyao.find(l => l.date === today) || {};
            
            const setBtn = (t, on, time) => {
                const el=document.getElementById(`check${t}`), tm=document.getElementById(`time${t}`);
                if(on) { el.classList.remove('hidden'); el.classList.add('flex'); tm.innerText=time; } 
                else { el.classList.add('hidden'); el.classList.remove('flex'); tm.innerText=""; }
            };
            setBtn('Am', log.taken_am, log.time_am); setBtn('Pm', log.taken_pm, log.time_pm);
            
            document.getElementById('medCard').className = (log.taken_am && log.taken_pm) ? "card shadow-apple bg-gradient-to-br from-emerald-500 to-green-500 text-white relative overflow-hidden transition-all duration-500" : "card shadow-apple bg-gradient-to-br from-blue-500 to-indigo-600 text-white relative overflow-hidden transition-all duration-500";
            document.getElementById('waterCount').innerText = log.water_count || 0;

            const stock = appData.tixing ? (appData.tixing.stock_last_save ? Math.max(0, appData.tixing.total_pills - Math.floor(dayjs().diff(dayjs(appData.tixing.stock_last_save), 'hour')/12)*2) : appData.tixing.total_pills) : 0;
            document.getElementById('stockCount').innerText = stock;
            document.getElementById('stockBar').style.width = `${Math.min(100, (stock/120)*100)}%`;

            const daysLeft = appData.tixing ? Math.max(0, dayjs(appData.tixing.next_visit_date).diff(dayjs(), 'day')) : 0;
            document.getElementById('daysUntil').innerText = daysLeft;
            document.getElementById('daysBar').style.width = `${Math.min(100, (daysLeft/30)*100)}%`;
            document.getElementById('visitDate').innerText = appData.tixing ? dayjs(appData.tixing.next_visit_date).format('YYYY-MM-DD') : '--';

            renderMenstruation();
            renderWeekHistory();
            renderCharts();
        }

        function renderWeekHistory() {
            const c = document.getElementById('weekHistory'); c.innerHTML = '';
            for(let i=6; i>=0; i--) {
                const d = dayjs().subtract(i, 'day'), l = appData.chiyao.find(x=>x.date===d.format('YYYY-MM-DD'));
                const dot = (ok) => `w-2 h-2 rounded-full ${ok ? 'bg-green-500' : (i===0 ? 'bg-gray-200 border border-gray-300' : 'bg-red-400 opacity-30')}`;
                c.innerHTML += `<div class="flex flex-col items-center gap-1"><span class="text-[10px] text-gray-400 font-bold">${d.format('DD')}</span><div class="${dot(l?.taken_am)}"></div><div class="${dot(l?.taken_pm)}"></div></div>`;
            }
        }

        function renderCharts() {
            const data = [...appData.tijian].filter(d=>dayjs(d.date).isAfter(dayjs().subtract(1,'year'))).sort((a,b)=>dayjs(a.date).diff(dayjs(b.date)));
            const labels = data.map(d=>dayjs(d.date).format('MM/DD'));
            
            if(window.myBcrChart) window.myBcrChart.destroy();
            window.myBcrChart = new Chart(document.getElementById('chartBcr').getContext('2d'), {
                type: 'line', data: { labels, datasets: [{ label: 'BCR-ABL', data: data.map(d=>d.bcr_abl<=0?0.0001:d.bcr_abl), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill:true, tension:0.3, spanGaps:true }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{type:'logarithmic', grid:{borderDash:[4,4]}}, x:{grid:{display:false}} } }
            });

            if(window.myBloodChart) window.myBloodChart.destroy();
            window.myBloodChart = new Chart(document.getElementById('chartBlood').getContext('2d'), {
                type: 'line', data: { labels, datasets: [{ label: 'WBC', data: data.map(d=>d.wbc), borderColor:'#10b981', backgroundColor:'#10b981', tension:0.3, yAxisID:'y', spanGaps:true }, { label: 'PLT', data: data.map(d=>d.plt), borderColor:'#f59e0b', backgroundColor:'#f59e0b', tension:0.3, yAxisID:'y1', spanGaps:true }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, interaction:{mode:'index', intersect:false}, scales:{ y:{position:'left', grid:{borderDash:[4,4]}, ticks:{color:'#10b981'}}, y1:{position:'right', grid:{display:false}, ticks:{color:'#f59e0b'}}, x:{grid:{display:false}} } }
            });
        }

        function showHistoryModal() {
            const list = document.getElementById('historyList'); list.innerHTML = '';
            appData.chiyao.slice().reverse().slice(0,60).forEach(l => {
                list.innerHTML += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100 mb-2"><div class="font-bold text-gray-700 text-sm w-16">${dayjs(l.date).format('MM/DD')}</div><div class="flex gap-2 flex-1 justify-end"><span class="text-xs px-2 py-1 rounded-md font-bold ${l.taken_am?'text-green-600 bg-green-50':'text-red-400 bg-red-50 opacity-60'}">â˜€ï¸ ${l.taken_am?l.time_am:'æœªæœ'}</span><span class="text-xs px-2 py-1 rounded-md font-bold ${l.taken_pm?'text-indigo-600 bg-indigo-50':'text-red-400 bg-red-50 opacity-60'}">ğŸŒ™ ${l.taken_pm?l.time_pm:'æœªæœ'}</span></div></div>`;
            });
            document.getElementById('historyModal').classList.remove('hidden');
        }

        function showLabHistory(t) {
            const list=document.getElementById('labHistoryList'), title=document.getElementById('labHistoryTitle'), h=document.getElementById('labHistoryHeader');
            list.innerHTML = ''; const d=[...appData.tijian].sort((a,b)=>dayjs(b.date).diff(dayjs(a.date)));
            if(t==='bcr') { title.innerText="èåˆåŸºå› å†å²"; h.innerText="ç»“æœ (%)"; d.forEach(x=>{ if(x.bcr_abl!=null) list.innerHTML+=`<div class="flex justify-between items-center p-3 bg-blue-50/50 rounded-xl border border-blue-100 mb-2"><span class="font-bold text-gray-700">${x.date}</span><span class="font-mono font-bold text-blue-600 text-lg">${x.bcr_abl}%</span></div>`}); }
            else { title.innerText="è¡€å¸¸è§„å†å²"; h.innerText="WBC / PLT"; d.forEach(x=>{ if(x.wbc||x.plt) list.innerHTML+=`<div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100 mb-2"><span class="font-bold text-gray-700">${x.date}</span><div class="flex gap-3"><span class="text-emerald-600 font-bold">W: ${x.wbc||'-'}</span><span class="text-amber-500 font-bold">P: ${x.plt||'-'}</span></div></div>`}); }
            document.getElementById('labHistoryModal').classList.remove('hidden');
        }

        function openEntryModal() { document.getElementById('entryModal').classList.remove('hidden'); document.getElementById('inDate').value=dayjs().format('YYYY-MM-DD'); document.getElementById('inStock').value=document.getElementById('stockCount').innerText; document.getElementById('inNextVisit').value=appData.tixing.next_visit_date; }
        function closeEntryModal() { document.getElementById('entryModal').classList.add('hidden'); }
        async function saveEntryData() {
            const btn=document.getElementById('btnSave'); btn.innerText="æäº¤ä¸­..."; btn.disabled=true;
            try {
                const date=document.getElementById('inDate').value, wbc=document.getElementById('inWbc').value, plt=document.getElementById('inPlt').value, bcr=document.getElementById('inBcr').value, stock=document.getElementById('inStock').value, visit=document.getElementById('inNextVisit').value;
                if(wbc||bcr||plt) appData.tijian.push({ date, wbc: wbc?parseFloat(wbc):null, plt: plt?parseFloat(plt):null, bcr_abl: bcr?parseFloat(bcr):null });
                if(stock) { appData.tixing.total_pills=parseInt(stock); appData.tixing.stock_last_save=dayjs().toISOString(); }
                appData.tixing.next_visit_date=visit;
                await Promise.all([saveFile('tijian.json', appData.tijian), saveFile('tixing.json', appData.tixing)]);
                location.reload();
            } catch(e) { location.reload(); }
        }

        function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); }
        function saveSettings() {
            const u=document.getElementById('cfgUser').value, r=document.getElementById('cfgRepo').value, t=document.getElementById('cfgToken').value;
            if(u&&r&&t) { localStorage.setItem(CACHE_KEY, JSON.stringify({user:u, repo:r, token:t})); location.reload(); }
        }
        function showError(m) { const b=document.getElementById('errorBox'); b.innerText=m; b.classList.remove('hidden'); setTimeout(()=>b.classList.add('hidden'),3000); }
        function setLoading(b) { document.getElementById('loadingOverlay').classList[b?'remove':'add']('hidden'); }
        if(config) { document.getElementById('cfgUser').value=config.user; document.getElementById('cfgRepo').value=config.repo; document.getElementById('cfgToken').value=config.token; }

        init();
    </script>
</body>
</html>