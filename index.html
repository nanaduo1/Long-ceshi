<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=noï¼Œviewport-fit=cover">
    <title>è€å©†ä¸‡å²</title>
    <link rel="manifest" href="/manifest.json">
    <!-- å…³é”®ï¼šè®¾ç½®ä¸»é¢˜è‰²ï¼Œè®©æ‰‹æœºçŠ¶æ€æ ä¸åŠ è½½èƒŒæ™¯èä¸ºä¸€ä½“ï¼Œé¿å…ç™½å± -->
    <meta name="theme-color" content="#667eea">

    <!-- æ·»åŠ åˆ°æ‰‹æœºä¸»å±å¹•çš„å›¾æ ‡ -->
    <link rel="apple-touch-icon" href="/images/icon.png">
    <link rel="shortcut icon" href="/images/icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang SC", Helvetica, Arial, sans-serif; 
            background-color: #F2F2F7; color: #1c1c1e; padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
            /* é˜²æ­¢iOSå›å¼¹æ•ˆæœéœ²å‡ºç™½è‰²èƒŒæ™¯ */
            overscroll-behavior-y: none;
        }
        .shadow-apple { box-shadow: 0 4px 20px rgba(0,0,0,0.05), 0 1px 4px rgba(0,0,0,0.03); }
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 16px; }
        .spinner { border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        input[type="date"], input[type="number"] {
            -webkit-appearance: none; appearance: none; min-height: 44px;
        }

        /* --- åŠ è½½å±æ ·å¼ (Loading Screen) --- */
        #splashScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            /* è“ç»¿æ¸å˜èƒŒæ™¯ */
            background: linear-gradient(135deg, #3eb97f 10%, #3664ef 100%);
            z-index: 9999; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }

        /* å®¹å™¨ */
        .loader-container {
            position: relative;
            width: 140px; height: 140px;
            filter: drop-shadow(0 0px 0px rgba(0, 0, 0, 0));
        }
        .heart-svg { width: 100%; height: 100%; overflow: visible; }

        /* æ¶²ä½“åŠ¨ç”» */
        .liquid-group { clip-path: url(#heartClip); }
        .liquid-fill { fill: url(#liquidGradient); }
        .wave {
            animation: wave-move 1.5s linear infinite;
            transform-origin: 50% 50%;
        }
        @keyframes wave-move {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* ç»ç’ƒè´¨æ„Ÿ */
        .glass-body {
            fill: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(2px);
        }
        .glass-stroke {
            fill: none; stroke: rgba(255, 255, 255, 0.6); stroke-width: 2;
            filter: drop-shadow(0 0 2px rgba(255,255,255,0.5));
        }
        .highlight-large { fill: url(#shineGradient); opacity: 0.8; pointer-events: none; }
        .highlight-small { fill: white; opacity: 0.9; filter: blur(1px); }

        /* åº•éƒ¨æ–‡å­— */
        .loading-text {
            margin-top: 30px;
            font-size: 12px; font-weight: Light; letter-spacing: 1.2px;
            display: flex; align-items: center; gap: 8px;
        }
        .dots::after { content: ''; animation: dots-anim 1.5s infinite steps(4, end); }
        @keyframes dots-anim {
            0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; }
        }
        #percentText { font-family: monospace; opacity: 0.8; font-size: 11px; }

    </style>
    <script>dayjs.locale('zh-cn');</script>
</head>
<body class="p-4 max-w-sm mx-auto">

    <!-- å…¨å±åŠ è½½å±‚ (Splash Screen) -->
    <div id="splashScreen">
        <div class="loader-container">
            <svg class="heart-svg" viewBox="0 0 100 90">
                <defs>
                    <path id="heartPath" d="M50,88 C50,88 12,65 12,35 C12,18 25,12 35,12 C42,12 48,16 50,22 C52,16 58,12 65,12 C75,12 88,18 88,35 C88,65 50,88 50,88 Z" />
                    <clipPath id="heartClip"><use href="#heartPath" /></clipPath>
                    <linearGradient id="liquidGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#ff6b6b;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#d63031;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="shineGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.9" />
                        <stop offset="50%" style="stop-color:#ffffff;stop-opacity:0.1" />
                        <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0" />
                    </linearGradient>
                </defs>
                <use href="#heartPath" class="glass-body" />
                <g class="liquid-group">
                    <g id="waveContainer" transform="translate(0, 90)">
                        <path class="wave" fill="url(#liquidGradient)" d="M0,0 C20,-4 30,-4 50,0 C70,4 80,4 100,0 C120,-4 130,-4 150,0 V100 H0 Z" transform="scale(2, 1)" />
                        <rect x="0" y="0" width="300" height="100" fill="url(#liquidGradient)" />
                    </g>
                </g>
                <use href="#heartPath" class="glass-stroke" />
                <path d="M35,16 C25,16 16,22 16,35" fill="none" stroke="white" stroke-width="3" opacity="0.4" stroke-linecap="round" />
                <ellipse cx="70" cy="25" rx="6" ry="3" transform="rotate(-30, 70, 25)" class="highlight-large" />
                <circle cx="75" cy="20" r="1.5" fill="white" opacity="0.9" />
            </svg>
        </div>
        <div class="loading-text">
            è€å…¬çš„çˆ±å¿ƒåŠ è½½ä¸­<span class="dots"></span> 
            <span id="percentText">0%</span>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢å†…å®¹ -->
    <div class="mt-4 mb-5 flex justify-between items-center px-1">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <div id="ghStatusDot" class="w-2 h-2 rounded-full bg-gray-300 transition-colors duration-500"></div>
                <p class="text-xs text-gray-500 font-bold uppercase tracking-wider" id="realTimeClock">Loading...</p>
            </div>
            <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">è€å©†ä¹ˆä¹ˆå“’â¤ï¸</h1>
        </div>
        <button onclick="openSettings()" class="bg-white p-2.5 rounded-full shadow-sm active:scale-95 transition">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        </button>
    </div>

    <div id="medCard" class="card shadow-apple bg-gradient-to-br from-blue-500 to-indigo-600 text-white relative overflow-hidden transition-all duration-500">
        <div id="loadingOverlay" class="absolute inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-20 hidden"><div class="spinner"></div></div>
        
        <div class="flex justify-between items-start mb-4">
            <div>
                <h2 class="text-base font-bold">å…¬ä¸»è¯·åƒè¯~</h2>
                <p class="text-xs opacity-80">è®°å¾—æ‰“å¡ï¼Œè®°å¾—å–æ°´å“¦</p>
            </div>
            <div class="flex items-center bg-black/10 rounded-lg px-2 py-1 gap-2">
                <span class="text-xs font-bold">ğŸ’§ <span id="waterCount">0</span>/<span id="waterTarget">8</span></span>
                <button onclick="updateWater(1)" class="w-5 h-5 bg-white/20 rounded text-xs flex items-center justify-center hover:bg-white/30">+</button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button onclick="checkIn('am')" id="btnAm" class="group relative flex flex-col items-center justify-center py-4 rounded-xl border border-white/20 bg-white/10 active:scale-95 transition-all">
                <div class="text-2xl mb-1 opacity-50">â˜€ï¸</div>
                <span class="text-sm font-bold opacity-80">æ—©æ™¨</span>
                <span id="timeAm" class="text-[10px] opacity-60 mt-1 h-3">--:--</span>
                <div id="checkAm" class="absolute inset-0 bg-white/95 rounded-xl hidden flex-col items-center justify-center text-green-600">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                    <span class="text-xs font-bold mt-1">å·²æœ (2ç²’)</span>
                </div>
            </button>
            <button onclick="checkIn('pm')" id="btnPm" class="group relative flex flex-col items-center justify-center py-4 rounded-xl border border-white/20 bg-white/10 active:scale-95 transition-all">
                <div class="text-2xl mb-1 opacity-50">ğŸŒ™</div>
                <span class="text-sm font-bold opacity-80">æ™šé—´</span>
                <span id="timePm" class="text-[10px] opacity-60 mt-1 h-3">--:--</span>
                <div id="checkPm" class="absolute inset-0 bg-white/95 rounded-xl hidden flex-col items-center justify-center text-indigo-600">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                    <span class="text-xs font-bold mt-1">å·²æœ (2ç²’)</span>
                </div>
            </button>
        </div>
    </div>

    <!-- ç§»åŠ¨åçš„ä½ç½®ï¼šå‘¨å†å²è§†å›¾ -->
    <div class="card shadow-apple p-4 mb-3">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-gray-800">è®©æˆ‘çœ‹çœ‹æœ‰æ²¡æœ‰æŒ‰æ—¶åƒè¯ğŸ˜</h3>
            <button onclick="showHistoryModal()" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md">è¯¦ç»†</button>
        </div>
        <div class="flex justify-between" id="weekHistory"></div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-3">
        <!-- è¯ç‰©åº“å­˜å¡ç‰‡ -->
        <div class="card shadow-apple mb-0 p-4 flex flex-col justify-between">
            <span class="text-xs font-bold text-gray-400 uppercase">çˆ±å¿ƒèƒ¶å›Š (ä¼°ç®—)</span>
            <div class="flex items-end gap-1 my-1">
                <span class="text-3xl font-extrabold text-gray-900" id="stockCount">--</span>
                <span class="text-xs text-gray-500 mb-1 font-bold">ç²’</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                <div id="stockBar" class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-[10px] text-gray-400 mt-1 text-right">æ€»å®¹é‡ 120</p>
        </div>
        
        <!-- è·ç¦»å¤æŸ¥å¡ç‰‡ -->
        <div class="card shadow-apple mb-0 p-4 flex flex-col justify-between">
            <span class="text-xs font-bold text-gray-400 uppercase">è·ç¦»å¤æŸ¥</span>
            <div class="flex items-end gap-1 my-1">
                <span class="text-3xl font-extrabold text-gray-900" id="daysUntil">--</span>
                <span class="text-xs text-gray-500 mb-1 font-bold">å¤©</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                <div id="daysBar" class="bg-orange-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-[10px] text-gray-400 mt-1 text-right">å¤æŸ¥æ—¥æœŸ <span id="visitDate">--/--</span></p>
        </div>
    </div>

    <!-- å¡ç‰‡ç»„ï¼šè·ç¦»åŸºå› æ£€æµ‹ ä¸ è·ç¦»ç”Ÿç†æœŸ -->
    <div class="grid grid-cols-2 gap-3 mb-3">
        <!-- è·ç¦»åŸºå› æ£€æµ‹å¡ç‰‡ -->
        <div class="card shadow-apple mb-0 p-4 flex flex-col justify-between relative overflow-hidden">
            <div class="flex justify-between items-start z-10">
                <span class="text-xs font-bold text-gray-400 uppercase">è·ç¦»åŸºå› æ£€æµ‹</span>
                <button onclick="openGeneModal()" class="text-gray-400 hover:text-gray-600 active:scale-95 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                </button>
            </div>
            <div class="flex items-end gap-1 my-1">
                <span class="text-3xl font-extrabold text-blue-600" id="geneDays">--</span>
                <span class="text-xs text-gray-500 mb-1 font-bold">å¤©</span>
            </div>
            <p class="text-[10px] text-gray-400 mt-1">è®¡åˆ’: <span id="geneDate">--</span></p>
        </div>

        <!-- è·ç¦»ç”Ÿç†æœŸå¡ç‰‡ -->
        <div id="periodCard" class="card shadow-apple mb-0 p-4 flex flex-col justify-between relative overflow-hidden transition-all duration-500">
            <div class="flex justify-between items-start z-10">
                <span id="periodTitle" class="text-xs font-bold text-gray-400 uppercase transition-colors">è·ç¦»ç”Ÿç†æœŸ</span>
                <button onclick="openPeriodModal()" id="periodPlusBtn" class="text-gray-400 hover:text-gray-600 active:scale-95 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                </button>
            </div>
            <div class="flex items-end gap-1 my-1 z-10">
                <span class="text-3xl font-extrabold text-gray-900 transition-colors" id="periodMainText">--</span>
                <span class="text-xs text-gray-500 mb-1 font-bold transition-colors" id="periodUnit">å¤©</span>
            </div>
            <p class="text-[10px] text-gray-400 mt-1 transition-colors z-10" id="periodSubText">é¢„ä¼°æ—¶é—´ --</p>
            
            <!-- èŠ±ç“£è£…é¥° (SVG) -->
            <div class="absolute -bottom-2 -right-2 w-16 h-16 opacity-20 pointer-events-none">
                 <svg viewBox="0 0 100 100" fill="currentColor" class="text-pink-300">
                    <path d="M50 50 C20 0 80 0 50 50 C80 20 80 80 50 50 C80 80 20 80 50 50 C20 80 20 20 50 50 Z" />
                 </svg>
            </div>
        </div>
    </div>

    <div class="card shadow-apple p-4 mb-3">
        <div class="flex justify-between items-center mb-2">
            <!-- å¼ºåˆ¶é«˜åº¦å®¹å™¨ -->
            <div class="h-10 flex flex-col justify-center">
                <div class="flex items-center gap-1">
                    <h3 class="text-sm font-bold text-gray-800">BCR-ABL % (è¿‘1å¹´)</h3>
                    <!-- ä¿¡æ¯å›¾æ ‡æŒ‰é’® -->
                    <button onclick="document.getElementById('infoModal').classList.remove('hidden')" class="text-gray-400 hover:text-blue-500 active:scale-95 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <span class="text-[10px] text-gray-400">ä¸‹æ¬¡åŸºå› æ£€æµ‹æ—¶é—´ä¸º4æœˆ</span>
            </div>
            <button onclick="showLabHistory('bcr')" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md h-7">è¯¦ç»†</button>
        </div>
        <div style="height: 180px;"><canvas id="chartBcr"></canvas></div>
    </div>

    <div class="card shadow-apple p-4 mb-6">
        <div class="flex justify-between items-center mb-2">
            <!-- å¼ºåˆ¶é«˜åº¦å®¹å™¨ -->
            <div class="h-10 flex flex-col justify-center">
                <h3 class="text-sm font-bold text-gray-800">è¡€å¸¸è§„è¶‹åŠ¿ (è¿‘1å¹´)</h3>
                <div class="flex gap-2 mt-0.5">
                    <span class="text-[10px] flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>WBC ç™½ç»†èƒ</span>
                    <span class="text-[10px] flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>PLT è¡€å°æ¿</span>
                </div>
            </div>
            <button onclick="showLabHistory('blood')" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md h-7">è¯¦ç»†</button>
        </div>
        <div style="height: 180px;"><canvas id="chartBlood"></canvas></div>
    </div>

    <div class="mx-1 mb-6 border border-amber-200 bg-amber-50 rounded-xl p-3 flex gap-3">
        <div class="text-amber-500 text-lg">ğŸ’¡</div>
        <div class="text-xs text-gray-600 leading-relaxed">
            <span class="font-bold text-gray-800">åŒ»å˜±ï¼š</span>
            <p>Â· ç©ºè…¹æœè¯ï¼Œé¤å2å°æ—¶åæœè¯ï¼Œæœè¯å1å°æ—¶ç¦é£Ÿï¼›</p>
            <p>Â· åœ¨12-18ä¸ªâ½‰å†…BCR-ABL1â‰¤0.1% è¡¨ç¤ºé¢„åè‰¯å¥½ï¼›</p>
            <p>Â· å¼€å§‹æ²»ç–—åæ¯3ä¸ªâ½‰åŸºå› æ£€æµ‹1æ¬¡ï¼Œå…±2å¹´ï¼›</p>
            <p>Â· 2å¹´åBCR-ABL1è¾¾åˆ°â‰¤1%ï¼Œæ¯3-6ä¸ªâ½‰æ£€æµ‹1æ¬¡ï¼›</p>
            <p>Â· BCR-ABL1â‰¤0.01%2å¹´ä»¥ä¸Šæ˜¯è€ƒè™‘åœè¯æŒ‡æ ‡ä¹‹â¼€ã€‚</p>
        </div>
    </div>

    <button onclick="openEntryModal()" class="w-full mb-12 bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl text-base font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
        <span>å½•å…¥åŒ–éªŒå• / æ ¡å‡†åº“å­˜</span>
    </button>

    <!-- åŸºå› æ£€æµ‹è®¾ç½®å¼¹çª— -->
    <div id="geneModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">è®¾ç½®ä¸‹æ¬¡åŸºå› æ£€æµ‹</h2>
                <button onclick="closeGeneModal()" class="bg-gray-100 rounded-full p-1 w-8 h-8 text-gray-500 font-bold">âœ•</button>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">ç›®æ ‡æ—¥æœŸ</label>
                <input type="date" id="inGeneDate" class="w-full bg-gray-100 rounded-lg p-3 text-sm font-bold outline-none">
            </div>

            <button onclick="saveGeneData()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-500/30">ä¿å­˜</button>
        </div>
    </div>

    <!-- ä¿¡æ¯å¼¹çª— -->
    <div id="infoModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">å‚è€ƒæ ‡å‡†</h3>
                <button onclick="document.getElementById('infoModal').classList.add('hidden')" class="bg-gray-100 rounded-full p-1 w-8 h-8 text-gray-500 font-bold hover:bg-gray-200 transition">âœ•</button>
            </div>
            
            <h4 class="text-sm font-bold text-blue-600 mb-2 mt-1">åˆ†å­ååº”å„é˜¶æ®µ</h4>
            <div class="overflow-hidden rounded-lg border border-gray-100 text-xs mb-5">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-gray-500 uppercase tracking-wider">
                        <tr>
                            <th class="px-3 py-2 font-medium">é˜¶æ®µ</th>
                            <th class="px-3 py-2 font-medium">åç§°</th>
                            <th class="px-3 py-2 font-medium text-right whitespace-nowrap">BCR-ABL</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 text-gray-700 font-medium">
                        <tr><td class="px-3 py-2">åˆè¯Š</td><td class="px-3 py-2 text-gray-500">æ´»è·ƒæœŸ</td><td class="px-3 py-2 text-right">â‰¥10%</td></tr>
                        <tr class="bg-gray-50/30"><td class="px-3 py-2">EMR</td><td class="px-3 py-2 text-gray-500">æ—©æœŸååº”</td><td class="px-3 py-2 text-right">â‰¤10%</td></tr>
                        <tr><td class="px-3 py-2 text-blue-600">MMR</td><td class="px-3 py-2 text-gray-500">ä¸»è¦ååº”</td><td class="px-3 py-2 text-right text-blue-600">â‰¤0.1%</td></tr>
                        <tr class="bg-gray-50/30"><td class="px-3 py-2">MR4</td><td class="px-3 py-2 text-gray-500">æ·±åº¦ç¼“è§£</td><td class="px-3 py-2 text-right">â‰¤0.01%</td></tr>
                        <tr><td class="px-3 py-2">MR4.5</td><td class="px-3 py-2 text-gray-500">ææ·±ç¼“è§£</td><td class="px-3 py-2 text-right">â‰¤0.0032%</td></tr>
                        <tr class="bg-green-50 text-green-700"><td class="px-3 py-2">CMR</td><td class="px-3 py-2">å®Œå…¨ç¼“è§£</td><td class="px-3 py-2 text-right">æœªæ£€å‡º</td></tr>
                    </tbody>
                </table>
            </div>

            <h4 class="text-sm font-bold text-blue-600 mb-2">é‡è¦æ—¶é—´èŠ‚ç‚¹</h4>
            <ul class="text-xs text-gray-600 space-y-2 ml-1 font-medium">
                <li class="flex justify-between items-center border-b border-gray-50 pb-1">
                    <span class="text-gray-500">3 ä¸ªæœˆ</span>
                    <span class="font-bold text-gray-800">â‰¤10%</span>
                </li>
                <li class="flex justify-between items-center border-b border-gray-50 pb-1">
                    <span class="text-gray-500">6â€“12 ä¸ªæœˆ</span>
                    <span class="font-bold text-gray-800">â‰¤0.1%</span>
                </li>
                <li class="flex justify-between items-center border-b border-gray-50 pb-1">
                    <span class="text-gray-500">1â€“2 å¹´</span>
                    <span class="font-bold text-gray-800">â‰¤0.01%</span>
                </li>
                <li class="flex justify-between items-center pt-1">
                    <span class="text-gray-500">â‰¥2 å¹´ç¨³å®š</span>
                    <span class="font-bold text-green-600">æœªæ£€å‡º</span>
                </li>
            </ul>
        </div>
    </div>

    <div id="entryModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center transition-opacity">
        <div class="bg-white w-full sm:max-w-sm rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold">æ›´æ–°æ•°æ®</h2>
                <button onclick="closeEntryModal()" class="bg-gray-100 rounded-full p-1 w-8 h-8 text-gray-500 font-bold">âœ•</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label>
                    <input type="date" id="inDate" class="w-full appearance-none m-0 bg-gray-100 rounded-xl p-3 text-sm font-bold outline-none text-gray-900 border-none">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ç™½ç»†èƒ (WBC)</label>
                        <input type="number" id="inWbc" placeholder="é€‰å¡«" class="w-full appearance-none m-0 bg-gray-100 rounded-xl p-3 text-sm font-bold outline-none text-gray-900">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">è¡€å°æ¿ (PLT)</label>
                        <input type="number" id="inPlt" placeholder="é€‰å¡«" class="w-full appearance-none m-0 bg-gray-100 rounded-xl p-3 text-sm font-bold outline-none text-gray-900">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">BCR-ABL %</label>
                    <input type="number" id="inBcr" placeholder="é€‰å¡«" class="w-full appearance-none m-0 bg-gray-100 rounded-xl p-3 text-sm font-bold outline-none text-gray-900">
                </div>
                
                <div class="border-t border-gray-100 my-2 pt-2">
                    <p class="text-xs text-blue-500 font-bold mb-3">é…ç½®æ›´æ–°</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">å½“å‰å®é™…åº“å­˜ (ç²’)</label>
                            <input type="number" id="inStock" class="w-full appearance-none m-0 bg-blue-50 text-blue-800 rounded-xl p-3 text-sm font-bold outline-none">
                            <p class="text-[10px] text-gray-400 mt-1">ä¿å­˜å°†é‡ç½®è‡ªåŠ¨æ‰£å‡æ—¶é—´</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ä¸‹æ¬¡å¤æŸ¥</label>
                            <input type="date" id="inNextVisit" class="w-full appearance-none m-0 bg-blue-50 text-blue-800 rounded-xl p-3 text-sm font-bold outline-none border-none">
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="saveEntryData()" id="btnSave" class="w-full mt-6 bg-blue-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-500/30">ä¿å­˜</button>
        </div>
    </div>

    <!-- æœˆç»è®°å½•å¼¹çª— -->
    <div id="periodModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center transition-opacity">
        <div class="bg-white w-full sm:max-w-sm rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up h-[70vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">ç”Ÿç†æœŸè®°å½•</h2>
                <button onclick="closePeriodModal()" class="bg-gray-100 rounded-full p-1 w-8 h-8 text-gray-500 font-bold">âœ•</button>
            </div>

            <div class="flex gap-3 mb-6">
                <button onclick="handlePeriodAction('start')" class="flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-pink-500/30 active:scale-95 transition">
                    å§¨å¦ˆæ¥äº† (å¼€å§‹)
                </button>
                <button onclick="handlePeriodAction('end')" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-200 active:scale-95 transition">
                    å§¨å¦ˆèµ°äº† (ç»“æŸ)
                </button>
            </div>

            <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase">å†å²è®°å½•</h3>
            <div id="periodHistoryList" class="flex-1 overflow-y-auto space-y-2 pb-4">
                <!-- å†å²åˆ—è¡¨ç”±JSç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æœˆç»æ—¥æœŸä¿®æ”¹å¼¹çª— -->
    <div id="periodEditModal" class="fixed inset-0 bg-black/50 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800">ä¿®æ”¹æ—¥æœŸ</h3>
                <button onclick="document.getElementById('periodEditModal').classList.add('hidden')" class="bg-gray-100 rounded-full p-1 w-6 h-6 text-gray-500 flex items-center justify-center text-xs">âœ•</button>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500 font-bold">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="editPeriodStart" class="w-full bg-gray-100 rounded-lg p-2 text-sm mt-1">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold">ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="editPeriodEnd" class="w-full bg-gray-100 rounded-lg p-2 text-sm mt-1">
                </div>
            </div>
            <div class="flex gap-2 mt-5">
                <button onclick="deletePeriodEntry()" class="flex-1 bg-red-50 text-red-500 py-2 rounded-lg text-sm font-bold">åˆ é™¤</button>
                <button onclick="savePeriodEdit()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg text-sm font-bold">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="fixed inset-0 bg-white z-50 hidden overflow-y-auto">
        <div class="p-4 max-w-sm mx-auto">
            <div class="flex justify-between items-center mb-6 mt-2">
                <h2 class="text-xl font-bold">æœè¯å†å²</h2>
                <button onclick="document.getElementById('historyModal').classList.add('hidden')" class="bg-gray-100 p-2 rounded-full text-sm font-bold text-gray-600">å…³é—­</button>
            </div>
            <div id="historyList" class="space-y-2 pb-20"></div>
        </div>
    </div>

    <div id="labHistoryModal" class="fixed inset-0 bg-white z-50 hidden overflow-y-auto">
        <div class="p-4 max-w-sm mx-auto">
            <div class="flex justify-between items-center mb-6 mt-2">
                <h2 class="text-xl font-bold" id="labHistoryTitle">åŒ–éªŒè®°å½•</h2>
                <button onclick="document.getElementById('labHistoryModal').classList.add('hidden')" class="bg-gray-100 p-2 rounded-full text-sm font-bold text-gray-600">å…³é—­</button>
            </div>
            <div class="border-b border-gray-100 pb-2 mb-2 flex justify-between text-xs font-bold text-gray-400 px-2">
                <span>æ—¥æœŸ</span>
                <span id="labHistoryHeader">æ•°å€¼</span>
            </div>
            <div id="labHistoryList" class="space-y-2 pb-20"></div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-6">
        <div class="bg-white w-full rounded-2xl p-6 shadow-2xl">
            <h2 class="text-lg font-bold mb-4">Github è¿æ¥</h2>
            <div class="space-y-3">
                <input type="text" id="cfgUser" class="w-full bg-gray-100 rounded-lg p-3 text-sm" placeholder="Github Username">
                <input type="text" id="cfgRepo" class="w-full bg-gray-100 rounded-lg p-3 text-sm" placeholder="Repository Name">
                <input type="password" id="cfgToken" class="w-full bg-gray-100 rounded-lg p-3 text-sm" placeholder="Access Token">
            </div>
            <button onclick="saveSettings()" class="w-full mt-4 bg-blue-600 text-white py-3 rounded-xl font-bold text-sm">ä¿å­˜å¹¶è¿æ¥</button>
            <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="w-full mt-2 text-gray-400 text-sm py-2">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="errorBox" class="hidden fixed top-20 left-4 right-4 bg-red-500 text-white p-3 rounded-xl shadow-xl z-[60] text-sm font-bold text-center transition-all"></div>

    <script>
        const CACHE_KEY = 'cml_config_v10';
        let config = JSON.parse(localStorage.getItem(CACHE_KEY));
        let appData = { tixing: null, chiyao: [], tijian: [], yuejing: [], jiyin: null }; // å¢åŠ  jiyin åˆå§‹åŒ–

        // --- æ ¸å¿ƒï¼šåˆå§‹åŒ–é€»è¾‘ ---
        async function init() {
            startClock();
            
            // 1. å¦‚æœæ²¡æœ‰é…ç½®ï¼Œç›´æ¥ç§»é™¤åŠ è½½å±å¹¶æ‰“å¼€è®¾ç½®ï¼Œä¸è¿›è¡Œç­‰å¾…
            if (!config) { 
                removeSplash();
                openSettings(); 
                return; 
            }
            
            // 2. å¯åŠ¨æ¶²ä½“å¡«å……åŠ¨ç”»ï¼ˆåœ¨åå°è¿è¡Œï¼‰
            startLiquidAnimation(3000); // 3ç§’å¡«æ»¡

            // 3. å¹¶è¡Œæ‰§è¡Œï¼šA. æœ€å°ç­‰å¾…æ—¶é—´ 3ç§’  B. åŠ è½½æ•°æ®
            const minWait = new Promise(resolve => setTimeout(resolve, 3000));
            
            const loadData = (async () => {
                try {
                    setGhStatus('loading');
                    await loadFile('tixing.json', 'tixing');
                    await loadFile('chiyao.json', 'chiyao');
                    await loadFile('tijian.json', 'tijian');
                    try { await loadFile('yuejing.json', 'yuejing'); } catch(e) { appData.yuejing = []; }
                    // æ–°å¢åŸºå› æ•°æ®åŠ è½½
                    try { await loadFile('jiyin.json', 'jiyin'); } catch(e) { appData.jiyin = { targetDate: "" }; }
                    setGhStatus('success');
                } catch (err) {
                    showError("åŒæ­¥å¤±è´¥: " + err.message);
                    setGhStatus('error');
                }
            })();

            // 4. ç­‰å¾…ä¸¤è€…éƒ½å®Œæˆ
            await Promise.all([minWait, loadData]);

            // 5. æ¸²æŸ“ç•Œé¢å¹¶ç§»é™¤åŠ è½½å±
            renderUI();
            removeSplash();
        }

        // --- æ¶²ä½“åŠ¨ç”»æ§åˆ¶ ---
        function startLiquidAnimation(duration) {
            const waveContainer = document.getElementById('waveContainer');
            const percentText = document.getElementById('percentText');
            // SVG Yè½´åæ ‡ï¼š90æ˜¯ç©º(åº•)ï¼Œ8æ˜¯æ»¡(é¡¶)
            const emptyY = 90, fullY = 8;
            let progress = 0;
            const interval = 20;
            const step = 100 / (duration / interval);

            const timer = setInterval(() => {
                progress += step;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(timer);
                }
                if(percentText) percentText.innerText = Math.floor(progress) + "%";
                if(waveContainer) {
                    const currentY = emptyY - ((emptyY - fullY) * (progress / 100));
                    waveContainer.setAttribute("transform", `translate(0, ${currentY})`);
                }
            }, interval);
        }

        // --- ç§»é™¤åŠ è½½å± ---
        function removeSplash() {
            const splash = document.getElementById('splashScreen');
            if(splash) {
                // æ·¡å‡ºå¹¶æ”¾å¤§ä¸€ç‚¹ç‚¹ï¼Œæ•ˆæœæ›´ç°ä»£
                splash.style.transform = "scale(1.05)";
                splash.style.opacity = '0';
                setTimeout(() => { 
                    splash.style.visibility = 'hidden'; 
                    splash.style.display = 'none'; // å½»åº•ç§»é™¤å¸ƒå±€å ç”¨
                }, 600);
            }
        }

        function startClock() {
            const update = () => { document.getElementById('realTimeClock').innerText = dayjs().format('MæœˆDæ—¥ dddd HH:mm:ss'); };
            update(); setInterval(update, 1000);
        }

        function setGhStatus(status) {
            const dot = document.getElementById('ghStatusDot');
            if(!dot) return;
            dot.className = "w-2 h-2 rounded-full transition-colors duration-500";
            if (status === 'success') dot.classList.add('bg-green-500', 'shadow-[0_0_8px_rgba(34,197,94,0.6)]');
            else if (status === 'error') dot.classList.add('bg-red-500');
            else dot.classList.add('bg-orange-400', 'animate-pulse');
        }

        async function loadFile(filename, key) {
            const res = await fetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${filename}`, {
                headers: { 'Authorization': `token ${config.token}`, 'Accept': 'application/vnd.github.v3+json' }, cache: "no-store"
            });
            if (!res.ok) throw new Error(filename + " " + res.status);
            const json = await res.json();
            appData[key] = JSON.parse(decodeURIComponent(escape(window.atob(json.content))));
        }

        async function saveFile(filename, contentObj) {
            const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${filename}`;
            const getRes = await fetch(url, { headers: { 'Authorization': `token ${config.token}` }, cache: "no-store" });
            if(!getRes.ok) throw new Error(`æ— æ³•è·å– ${filename} æœ€æ–°ç‰ˆæœ¬`);
            const getJson = await getRes.json();
            
            const contentBase64 = window.btoa(unescape(encodeURIComponent(JSON.stringify(contentObj, null, 2))));
            const res = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Update ${filename}`, content: contentBase64, sha: getJson.sha })
            });
            if (!res.ok) throw new Error("ä¿å­˜å¤±è´¥");
        }

        async function checkIn(type) {
            setLoading(true);
            try {
                const today = dayjs().format('YYYY-MM-DD');
                if (!Array.isArray(appData.chiyao)) appData.chiyao = [];
                let log = appData.chiyao.find(l => l.date === today);
                if (!log) { log = { date: today, taken_am: false, time_am: "", taken_pm: false, time_pm: "", water_count: 0 }; appData.chiyao.push(log); }

                if ((type === 'am' && log.taken_am) || (type === 'pm' && log.taken_pm)) { setLoading(false); return; }
                
                if (type === 'am') { log.taken_am = true; log.time_am = dayjs().format('HH:mm'); }
                if (type === 'pm') { log.taken_pm = true; log.time_pm = dayjs().format('HH:mm'); }

                await saveFile('chiyao.json', appData.chiyao);
                
                renderUI(); setGhStatus('success');
            } catch (e) { showError(e.message); setGhStatus('error'); }
            setLoading(false);
        }

        async function updateWater(delta) {
            const today = dayjs().format('YYYY-MM-DD');
            let log = appData.chiyao.find(l => l.date === today);
            if (!log) { log = { date: today, taken_am: false, taken_pm: false, water_count: 0 }; appData.chiyao.push(log); }
            log.water_count = (log.water_count || 0) + delta;
            document.getElementById('waterCount').innerText = log.water_count;
            try { await saveFile('chiyao.json', appData.chiyao); } catch(e){}
        }

        function calculateStock() {
            if (!appData.tixing || !appData.tixing.total_pills) return 0;
            if (!appData.tixing.stock_last_save) return appData.tixing.total_pills;
            const lastSave = dayjs(appData.tixing.stock_last_save);
            const now = dayjs();
            const hoursPassed = now.diff(lastSave, 'hour');
            const deductions = Math.floor(hoursPassed / 12);
            const consumed = deductions * 2;
            return Math.max(0, appData.tixing.total_pills - consumed);
        }

        function renderUI() {
            const today = dayjs().format('YYYY-MM-DD');
            const log = appData.chiyao.find(l => l.date === today) || {};
            
            const updateBtn = (type, taken, time) => {
                const cap = type.charAt(0).toUpperCase() + type.slice(1);
                const el = document.getElementById(`check${cap}`);
                const tm = document.getElementById(`time${cap}`);
                if(taken) { el.classList.remove('hidden'); el.classList.add('flex'); tm.innerText=time; } else { el.classList.add('hidden'); el.classList.remove('flex'); tm.innerText=""; }
            };
            updateBtn('am', log.taken_am, log.time_am);
            updateBtn('pm', log.taken_pm, log.time_pm);
            const card = document.getElementById('medCard');
            if(log.taken_am && log.taken_pm) card.className = "card shadow-apple bg-gradient-to-br from-emerald-500 to-green-500 text-white relative overflow-hidden transition-all duration-500";
            else card.className = "card shadow-apple bg-gradient-to-br from-blue-500 to-indigo-600 text-white relative overflow-hidden transition-all duration-500";

            document.getElementById('waterCount').innerText = log.water_count || 0;
            
            const calculatedStock = calculateStock();
            document.getElementById('stockCount').innerText = calculatedStock;
            document.getElementById('stockBar').style.width = `${Math.min(100, (calculatedStock / 120) * 100)}%`;
            
            const daysLeft = Math.max(0, dayjs(appData.tixing.next_visit_date).diff(dayjs(), 'day'));
            document.getElementById('daysUntil').innerText = daysLeft;
            const maxRevisitDays = 30; 
            const revisitPercent = Math.min(100, (daysLeft / maxRevisitDays) * 100);
            document.getElementById('daysBar').style.width = `${revisitPercent}%`;
            document.getElementById('visitDate').innerText = dayjs(appData.tixing.next_visit_date).format('YYYY-MM-DD');

            renderWeekHistory();
            renderCharts();
            renderPeriodCard(); 
            renderGeneCard(); // æ¸²æŸ“åŸºå› å¡ç‰‡
        }
        
        // --- æ–°å¢åŠŸèƒ½ï¼šåŸºå› æ£€æµ‹é€»è¾‘ ---
        function renderGeneCard() {
            if (!appData.jiyin || !appData.jiyin.targetDate) {
                document.getElementById('geneDays').innerText = "--";
                document.getElementById('geneDate').innerText = "æœªè®¾ç½®";
                return;
            }
            const target = dayjs(appData.jiyin.targetDate);
            const today = dayjs();
            const diff = target.diff(today, 'day');
            
            document.getElementById('geneDays').innerText = diff > 0 ? diff : 0;
            document.getElementById('geneDate').innerText = target.format('YYYY-MM-DD');
        }

        function openGeneModal() {
            document.getElementById('geneModal').classList.remove('hidden');
            if(appData.jiyin && appData.jiyin.targetDate) {
                document.getElementById('inGeneDate').value = appData.jiyin.targetDate;
            }
        }
        function closeGeneModal() { document.getElementById('geneModal').classList.add('hidden'); }

        async function saveGeneData() {
            const date = document.getElementById('inGeneDate').value;
            if (date) {
                appData.jiyin = { targetDate: date };
                await saveFile('jiyin.json', appData.jiyin);
                closeGeneModal();
                renderUI();
            }
        }

        // --- æœˆç»é€»è¾‘ä¸æ¸²æŸ“ ---
        function renderPeriodCard() {
            if (!appData.yuejing || appData.yuejing.length === 0) {
                document.getElementById('periodMainText').innerText = "--";
                document.getElementById('periodSubText').innerText = "è¯·å½•å…¥æ•°æ®";
                return;
            }

            // æŒ‰å¼€å§‹æ—¥æœŸå€’åºæ’åˆ—
            const sorted = appData.yuejing.sort((a, b) => dayjs(b.startDate).diff(dayjs(a.startDate)));
            const lastRecord = sorted[0];
            const today = dayjs();
            const start = dayjs(lastRecord.startDate);
            // é»˜è®¤ç»æœŸé•¿åº¦ 5 å¤©ï¼Œå‘¨æœŸ 28 å¤©
            const duration = 5; 
            const cycle = 28;

            // åˆ¤æ–­æ˜¯å¦åœ¨ç»æœŸä¸­
            let isPeriodActive = false;
            let daysInto = 0;
            
            // å¦‚æœæœ‰ç»“æŸæ—¥æœŸï¼Œæ ¹æ®ç»“æŸæ—¥æœŸåˆ¤æ–­ï¼›å¦‚æœæ²¡æœ‰ï¼Œé»˜è®¤5å¤©åç»“æŸ
            const endDate = lastRecord.endDate ? dayjs(lastRecord.endDate) : start.add(duration, 'day');
            
            if ((today.isSame(start, 'day') || today.isAfter(start, 'day')) && (today.isSame(endDate, 'day') || today.isBefore(endDate, 'day'))) {
                isPeriodActive = true;
                daysInto = today.diff(start, 'day') + 1;
            }

            const card = document.getElementById('periodCard');
            const title = document.getElementById('periodTitle');
            const mainText = document.getElementById('periodMainText');
            const subText = document.getElementById('periodSubText');
            const unit = document.getElementById('periodUnit');
            const btn = document.getElementById('periodPlusBtn');

            if (isPeriodActive) {
                // æœˆç»æœŸæ ·å¼ï¼šç²‰è‰²æ¸å˜ï¼Œåç™½æ–‡å­—
                card.className = "card shadow-apple mb-0 p-4 flex flex-col justify-between relative overflow-hidden transition-all duration-500 bg-gradient-to-br from-pink-400 to-rose-500";
                title.className = "text-xs font-bold text-white/80 uppercase transition-colors";
                mainText.className = "text-3xl font-extrabold text-white transition-colors";
                subText.className = "text-[10px] text-white/80 mt-1 transition-colors z-10";
                unit.className = "text-xs text-white/80 mb-1 font-bold transition-colors";
                btn.className = "text-white/80 hover:text-white active:scale-95 transition-all";

                title.innerText = "ç”Ÿç†æœŸä¸­";
                mainText.innerText = daysInto;
                unit.innerText = "å¤©";
                subText.innerText = `å¼€å§‹äº ${start.format('MM-DD')}`;
            } else {
                // éæœˆç»æœŸæ ·å¼ï¼šæ¢å¤åŸæ ·
                card.className = "card shadow-apple mb-0 p-4 flex flex-col justify-between relative overflow-hidden transition-all duration-500 bg-white";
                title.className = "text-xs font-bold text-gray-400 uppercase transition-colors";
                mainText.className = "text-3xl font-extrabold text-gray-900 transition-colors";
                subText.className = "text-[10px] text-gray-400 mt-1 transition-colors z-10";
                unit.className = "text-xs text-gray-500 mb-1 font-bold transition-colors";
                btn.className = "text-gray-400 hover:text-gray-600 active:scale-95 transition-all";

                title.innerText = "è·ç¦»ç”Ÿç†æœŸ";
                
                // é¢„æµ‹ä¸‹ä¸€æ¬¡ï¼šä¸Šæ¬¡å¼€å§‹ + 28å¤©
                const nextStart = start.add(cycle, 'day');
                const daysUntil = nextStart.diff(today, 'day');
                
                // å¦‚æœ daysUntil < 0ï¼Œè¯´æ˜å·²ç»æ¨è¿Ÿäº†
                if (daysUntil < 0) {
                    mainText.innerText = Math.abs(daysUntil);
                    unit.innerText = "å¤© (æ¨è¿Ÿ)";
                    mainText.classList.add('text-red-500');
                } else {
                    mainText.innerText = daysUntil;
                    unit.innerText = "å¤©";
                    mainText.classList.remove('text-red-500');
                }
                
                const nextEnd = nextStart.add(duration - 1, 'day'); // æŒç»­5å¤©ï¼Œæ‰€ä»¥æ˜¯ start + 4
                subText.innerText = `é¢„ä¼°æ—¶é—´ ${nextStart.format('YYYY-MM-DD')}ï½${nextEnd.format('DD')}`;
            }
        }

        // æœˆç»å¼¹çª—é€»è¾‘
        let editingIndex = -1;

        function openPeriodModal() {
            document.getElementById('periodModal').classList.remove('hidden');
            renderPeriodHistory();
        }
        function closePeriodModal() { document.getElementById('periodModal').classList.add('hidden'); }

        async function handlePeriodAction(action) {
            const today = dayjs().format('YYYY-MM-DD');
            if (!appData.yuejing) appData.yuejing = [];
            
            // æ’åºï¼Œæ‰¾æœ€è¿‘ä¸€æ¬¡
            appData.yuejing.sort((a, b) => dayjs(b.startDate).diff(dayjs(a.startDate)));
            
            if (action === 'start') {
                // å¦‚æœæœ€è¿‘ä¸€æ¬¡è¿˜æ²¡æœ‰ç»“æŸï¼Œå…ˆå¼ºåˆ¶ç»“æŸå®ƒï¼ˆæˆ–è€…æç¤ºï¼‰ï¼Ÿè¿™é‡Œç®€åŒ–é€»è¾‘ï¼šç›´æ¥æ–°å¢
                // é™¤éä»Šå¤©å·²ç»æ˜¯å¼€å§‹æ—¥æœŸ
                if (appData.yuejing.length > 0 && appData.yuejing[0].startDate === today) {
                    // å·²å­˜åœ¨ä»Šå¤©å¼€å§‹çš„è®°å½•ï¼Œå¿½ç•¥
                } else {
                    appData.yuejing.unshift({ startDate: today, endDate: null }); // åŠ åˆ°æœ€å‰
                }
            } else if (action === 'end') {
                // ç»“æŸæœ€è¿‘çš„ä¸€æ¬¡
                if (appData.yuejing.length > 0) {
                    appData.yuejing[0].endDate = today;
                }
            }
            
            await saveFile('yuejing.json', appData.yuejing);
            renderUI();
            renderPeriodHistory();
        }

        function renderPeriodHistory() {
            const list = document.getElementById('periodHistoryList');
            list.innerHTML = '';
            
            if (!appData.yuejing) return;
            // å€’åºæ˜¾ç¤º
            const sorted = appData.yuejing.sort((a, b) => dayjs(b.startDate).diff(dayjs(a.startDate)));
            
            sorted.forEach((item, index) => {
                const startStr = item.startDate;
                const endStr = item.endDate ? item.endDate : (dayjs(startStr).add(4, 'day').format('YYYY-MM-DD') + " (è‡ªåŠ¨)");
                
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100 relative group active:scale-[0.98] transition";
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-base font-bold text-pink-500">${startStr}</span>
                        <span class="text-gray-300">~</span>
                        <span class="text-sm font-light text-gray-600">${endStr}</span>
                    </div>
                    <div class="text-gray-300">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </div>
                `;
                div.onclick = () => openPeriodEdit(index); // index æ˜¯åŸºäº sorted çš„
                list.appendChild(div);
            });
        }

        function openPeriodEdit(index) {
            editingIndex = index;
            const item = appData.yuejing[index];
            document.getElementById('editPeriodStart').value = item.startDate;
            document.getElementById('editPeriodEnd').value = item.endDate || '';
            document.getElementById('periodEditModal').classList.remove('hidden');
        }

        async function savePeriodEdit() {
            const s = document.getElementById('editPeriodStart').value;
            const e = document.getElementById('editPeriodEnd').value;
            if(s) {
                appData.yuejing[editingIndex].startDate = s;
                appData.yuejing[editingIndex].endDate = e || null;
                await saveFile('yuejing.json', appData.yuejing);
                document.getElementById('periodEditModal').classList.add('hidden');
                renderPeriodHistory();
                renderUI();
            }
        }

        async function deletePeriodEntry() {
            if (confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
                appData.yuejing.splice(editingIndex, 1);
                await saveFile('yuejing.json', appData.yuejing);
                document.getElementById('periodEditModal').classList.add('hidden');
                renderPeriodHistory();
                renderUI();
            }
        }

        function renderWeekHistory() {
            const container = document.getElementById('weekHistory');
            container.innerHTML = '';
            for(let i=6; i>=0; i--) {
                const d = dayjs().subtract(i, 'day');
                const log = appData.chiyao.find(l=>l.date===d.format('YYYY-MM-DD'));
                const isToday = i===0;
                const dot = (taken) => `w-2 h-2 rounded-full ${taken ? 'bg-green-500' : (isToday ? 'bg-gray-200 border border-gray-300' : 'bg-red-400 opacity-30')}`;
                container.innerHTML += `<div class="flex flex-col items-center gap-1"><span class="text-[10px] text-gray-400 font-bold">${d.format('DD')}</span><div class="${dot(log?.taken_am)}"></div><div class="${dot(log?.taken_pm)}"></div></div>`;
            }
        }

        function renderCharts() {
            const oneYearAgo = dayjs().subtract(1, 'year');
            const data = [...appData.tijian]
                .filter(d => dayjs(d.date).isAfter(oneYearAgo))
                .sort((a,b)=>dayjs(a.date).diff(dayjs(b.date)));
            
            const labels = data.map(d=>dayjs(d.date).format('MM/DD'));

            const bcrData = data.map(d => {
                let val = parseFloat(d.bcr_abl);
                if(isNaN(val)) return null;
                return val <= 0 ? 0.0001 : val; 
            });

            const commonOpts = { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} };

            if(window.myBcrChart) window.myBcrChart.destroy();
            window.myBcrChart = new Chart(document.getElementById('chartBcr').getContext('2d'), {
                type: 'line',
                data: { labels, datasets: [{ 
                    label: 'BCR-ABL', data: bcrData, 
                    borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', 
                    fill:true, tension:0.3, spanGaps: true 
                }] },
                options: { ...commonOpts, scales:{ y:{type:'logarithmic', grid:{borderDash:[4,4]}}, x:{grid:{display:false}} } }
            });

            const safetyZonesPlugin = {
                id: 'safetyZones',
                beforeDraw: (chart) => {
                    const { ctx, chartArea: { left, top, right, bottom, width, height }, scales: { y, y1 } } = chart;
                    
                    if(y) {
                        const yTop = y.getPixelForValue(9.5); 
                        const yBottom = y.getPixelForValue(3.5);
                        if (yBottom > top && yTop < bottom) {
                            ctx.save();
                            ctx.fillStyle = 'rgba(16, 185, 129, 0.1)'; 
                            const rectTop = Math.max(top, yTop);
                            const rectBottom = Math.min(bottom, yBottom);
                            if(rectBottom > rectTop) ctx.fillRect(left, rectTop, width, rectBottom - rectTop);
                            ctx.restore();
                        }
                    }
                    if(y1) {
                        const y1Top = y1.getPixelForValue(350);
                        const y1Bottom = y1.getPixelForValue(125);
                        if (y1Bottom > top && y1Top < bottom) {
                            ctx.save();
                            ctx.fillStyle = 'rgba(245, 158, 11, 0.1)'; 
                            const rectTop = Math.max(top, y1Top);
                            const rectBottom = Math.min(bottom, y1Bottom);
                            if(rectBottom > rectTop) ctx.fillRect(left, rectTop, width, rectBottom - rectTop);
                            ctx.restore();
                        }
                    }
                }
            };

            if(window.myBloodChart) window.myBloodChart.destroy();
            window.myBloodChart = new Chart(document.getElementById('chartBlood').getContext('2d'), {
                type: 'line',
                data: { labels, datasets: [
                    { label: 'WBC', data: data.map(d=>d.wbc), borderColor: '#10b981', backgroundColor: '#10b981', tension:0.3, yAxisID:'y', spanGaps: true },
                    { label: 'PLT', data: data.map(d=>d.plt), borderColor: '#f59e0b', backgroundColor: '#f59e0b', tension:0.3, yAxisID:'y1', spanGaps: true }
                ]},
                plugins: [safetyZonesPlugin], 
                options: { 
                    ...commonOpts,
                    interaction:{mode:'index', intersect:false},
                    scales:{ 
                        y:{
                            position:'left', grid:{borderDash:[4,4]},
                            ticks: { color: '#10b981' }, border: { color: '#10b981', display: true }
                        }, 
                        y1:{
                            position:'right', grid:{display:false},
                            ticks: { color: '#f59e0b' }, border: { color: '#f59e0b', display: true }
                        }, 
                        x:{grid:{display:false}} 
                    }
                }
            });
        }

        function showHistoryModal() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            appData.chiyao.slice().reverse().slice(0,60).forEach(l => {
                const amTime = l.taken_am ? l.time_am : 'æœªæœ';
                const pmTime = l.taken_pm ? l.time_pm : 'æœªæœ';
                const amStyle = l.taken_am ? 'text-green-600 bg-green-50' : 'text-red-400 bg-red-50 opacity-60';
                const pmStyle = l.taken_pm ? 'text-indigo-600 bg-indigo-50' : 'text-red-400 bg-red-50 opacity-60';
                list.innerHTML += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100 mb-2"><div class="font-bold text-gray-700 text-sm w-16">${dayjs(l.date).format('MM/DD')}</div><div class="flex gap-2 flex-1 justify-end"><span class="text-xs px-2 py-1 rounded-md font-bold ${amStyle}">â˜€ï¸ ${amTime}</span><span class="text-xs px-2 py-1 rounded-md font-bold ${pmStyle}">ğŸŒ™ ${pmTime}</span></div></div>`;
            });
            document.getElementById('historyModal').classList.remove('hidden');
        }

        function showLabHistory(type) {
            const list = document.getElementById('labHistoryList');
            const title = document.getElementById('labHistoryTitle');
            const header = document.getElementById('labHistoryHeader');
            list.innerHTML = '';
            const data = [...appData.tijian].sort((a,b)=>dayjs(b.date).diff(dayjs(a.date)));

            if (type === 'bcr') {
                title.innerText = "èåˆåŸºå› å†å² (BCR-ABL)";
                header.innerText = "ç»“æœ (%)";
                data.forEach(d => {
                    if (d.bcr_abl !== null && d.bcr_abl !== undefined) {
                        list.innerHTML += `<div class="flex justify-between items-center p-3 bg-blue-50/50 rounded-xl border border-blue-100 mb-2"><span class="font-bold text-gray-700">${d.date}</span><span class="font-mono font-bold text-blue-600 text-lg">${d.bcr_abl}%</span></div>`;
                    }
                });
            } else {
                title.innerText = "è¡€å¸¸è§„å†å²";
                header.innerText = "WBC / PLT";
                data.forEach(d => {
                    if (d.wbc || d.plt) {
                        list.innerHTML += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100 mb-2"><span class="font-bold text-gray-700">${d.date}</span><div class="flex gap-3"><span class="text-emerald-600 font-bold">W: ${d.wbc||'-'}</span><span class="text-amber-500 font-bold">P: ${d.plt||'-'}</span></div></div>`;
                    }
                });
            }
            document.getElementById('labHistoryModal').classList.remove('hidden');
        }

        function openEntryModal() {
            document.getElementById('entryModal').classList.remove('hidden');
            document.getElementById('inDate').value = dayjs().format('YYYY-MM-DD');
            document.getElementById('inStock').value = calculateStock();
            document.getElementById('inNextVisit').value = appData.tixing.next_visit_date;
        }
        function closeEntryModal() { document.getElementById('entryModal').classList.add('hidden'); }
        
        async function saveEntryData() {
            const btn = document.getElementById('btnSave');
            btn.innerText = "æäº¤ä¸­..."; btn.disabled = true;
            try {
                const date = document.getElementById('inDate').value;
                const wbc = document.getElementById('inWbc').value;
                const plt = document.getElementById('inPlt').value;
                const bcr = document.getElementById('inBcr').value;
                
                if(wbc||bcr||plt) {
                    appData.tijian.push({ date, wbc: wbc?parseFloat(wbc):null, plt: plt?parseFloat(plt):null, bcr_abl: bcr?parseFloat(bcr):null });
                }
                const stock = parseInt(document.getElementById('inStock').value);
                if(!isNaN(stock)) {
                    appData.tixing.total_pills = stock;
                    appData.tixing.stock_last_save = dayjs().toISOString(); 
                }
                appData.tixing.next_visit_date = document.getElementById('inNextVisit').value;
                await Promise.all([saveFile('tijian.json', appData.tijian), saveFile('tixing.json', appData.tixing)]);
                location.reload(); 
            } catch(e) { console.error(e); location.reload(); }
        }

        function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); }
        function saveSettings() {
            const u=document.getElementById('cfgUser').value, r=document.getElementById('cfgRepo').value, t=document.getElementById('cfgToken').value;
            if(u&&r&&t) { localStorage.setItem(CACHE_KEY, JSON.stringify({user:u, repo:r, token:t})); location.reload(); }
        }
        function showError(msg) { const b=document.getElementById('errorBox'); b.innerText=msg; b.classList.remove('hidden'); setTimeout(()=>b.classList.add('hidden'),3000); }
        function setLoading(b) { document.getElementById('loadingOverlay').classList[b?'remove':'add']('hidden'); }
        if(config) { document.getElementById('cfgUser').value=config.user; document.getElementById('cfgRepo').value=config.repo; document.getElementById('cfgToken').value=config.token; }

        init();
    </script>
</body>
</html>